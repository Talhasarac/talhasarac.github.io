(function(){"use strict";const k=navigator.webdriver||/bot|spider/i.test(navigator.userAgent);let h=0,u=0;const f=document.querySelector(".history-container"),r=document.querySelector("#js-history-load"),g=document.querySelector(".history-filters-container"),y=document.querySelector("#js-filter-history-load"),s=document.querySelector("#js-filter-history-key"),a=document.querySelector("#js-filter-history-date"),w=document.querySelector("#js-history-loading"),b=new window.diff_match_patch,v=function(e){e.forEach(t=>{const i=b.diff_main(t.querySelector("del").textContent,t.querySelector("ins").textContent);b.diff_cleanupSemantic(i),b.diff_cleanupEfficiency(i),t.innerHTML=b.diff_prettyHtml(i)})};if(v(document.querySelectorAll(".diff")),y&&y.addEventListener("click",function(){this.disabled=!0,this.textContent="Loading\u2026";let e;switch(r.dataset.scope){case"app":e=`appid=${r.dataset.appid}`;break;case"sub":e=`subid=${r.dataset.subid}`;break}fetch(`/api/GetHistoryFilters/?${e}`,{headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}}).then(t=>{if(!t.ok){const i=new Error(`HTTP ${t.status}`);throw i.name="ServerError",i}return t.json()}).then(t=>{if(y.hidden=!0,t&&t.success){for(const i of t.data){const n=document.createElement("option");n.value=i.Key,n.textContent=i.Name,s.appendChild(n),h===i.Key&&(n.selected=!0)}s.hidden=!1}}).catch(t=>{throw y.textContent="Failed to load history filters",window.SteamDB.Alert("Failed to load history filters: "+t),t})},{once:!0}),s){s.addEventListener("change",function(){u=0,h=this.value,f.replaceChildren(),p();const t=new URLSearchParams(location.search);h>0?t.set("filterkey",h):t.delete("filterkey"),history.replaceState(null,null,Array.from(t).length?`${location.pathname}?${t}`:location.pathname)});const e=new URLSearchParams(location.search);if(e.has("filterkey"))if(h=parseInt(e.get("filterkey"),10)||0,y)y.click();else{const t=s.querySelector(`option[value="${h}"]`);t&&(t.selected=!0)}}a&&(a.max=new Date().toISOString().substring(0,10),document.querySelector("#js-filter-history-date-load").addEventListener("click",e=>{e.preventDefault(),a.checkValidity()&&(u=0,f.replaceChildren(),p())}),document.querySelector("#js-filter-history-date-reset").addEventListener("click",e=>{e.preventDefault(),u=0,a.value=null,f.replaceChildren(),p()}),document.querySelector("#js-filter-history-date-toggle").addEventListener("click",e=>{e.preventDefault();const t=document.querySelector(".history-filter-date");t.hidden=!t.hidden,t.hidden?a.value=null:a.focus()})),r&&(r.addEventListener("click",()=>{!r.hidden&&!r.disabled&&p()}),document.getElementById("js-history-back").addEventListener("click",function(e){e.preventDefault(),history.replaceState(null,null,this.href),u=0,delete r.dataset.changeid,g&&(g.hidden=!1),document.getElementById("js-history-header-single").hidden=!0;const t=document.getElementById("js-history-header-all");t.hidden=!1,t.scrollIntoView({behavior:"smooth",block:"nearest"}),f.replaceChildren(),p()}));function E(e){if(document.body.classList.contains("page-history")||document.body.classList.contains("page-changelists"))return;e.preventDefault(),document.getElementById("js-history-back").href=location.href,history.replaceState(null,null,this.href);const t=new URL(this.href),i=new URLSearchParams(t.search);r.dataset.changeid=i.get("changeid"),u=0,g&&(g.hidden=!0),document.getElementById("js-history-header-all").hidden=!0;const n=document.getElementById("js-history-header-single");n.querySelector("b").textContent=i.get("changeid"),n.hidden=!1,n.scrollIntoView({behavior:"smooth",block:"nearest"}),f.replaceChildren(),p()}function p(){s&&(s.disabled=!0),a&&(a.disabled=!0),w.hidden=!1,r.hidden=!0,r.parentNode.hidden=!1;const e=new URLSearchParams;e.append("lastentry",u),r.dataset.changeid?e.append("changeid",r.dataset.changeid):(h>0&&e.append("key",h),u===0&&a&&a.value&&e.append("before",a.value));const t=(n,S,o)=>{if(r.hidden=!1,s&&(s.disabled=!1),a&&(a.disabled=!1),S===0){r.parentNode.hidden=!0;return}const d=document.createElement("div");d.innerHTML=n;const m=d.querySelector(".panel-history:first-child");if(m){const c=f.querySelector('.panel-history[data-changeid="'+m.dataset.changeid+'"]');c&&(c.querySelector(".app-history").append(...m.querySelector(".app-history").childNodes),m.remove())}if(v(d.querySelectorAll(".diff")),window.SteamDB.BindHover&&window.SteamDB.BindHover(d),window.SteamDB.BindImageHover){const c=d.querySelectorAll(".image-hover");c.length>0&&window.SteamDB.BindImageHover(c)}const l=d.querySelectorAll(".app-history-permalink");for(const c of l)c.addEventListener("click",E);f.append(...d.childNodes),f.querySelectorAll(".timeago").forEach(c=>TimeAgo.init(c)),w.hidden=!0,o?S===-1?(r.disabled=!0,r.hidden=!0,document.getElementById("js-history-signin").hidden=!1):u=S:r.parentNode.hidden=!0},i=(n,S)=>{fetch(`/api/${n}/?${S.toString()}`,{headers:{Accept:"text/html","X-Requested-With":"XMLHttpRequest"}}).then(o=>{if(!o.ok){const l=new Error(`HTTP ${o.status}`);throw l.name="ServerError",l}const d=o.headers.get("X-SteamDB-History-LastChangeID"),m=o.headers.get("X-SteamDB-History-More");if(d===null){const l=new Error("No history was returned.");throw l.name="ServerError",l}o.text().then(l=>t(l,parseInt(d,10),m==="yes"))}).catch(o=>{if(r.parentNode.hidden=!0,window.SteamDB.Alert("Failed to load history: "+o),o.name!=="ServerError")throw o})};switch(r.dataset.scope){case"app":e.append("appid",r.dataset.appid),i("GetAppHistory",e);break;case"sub":e.append("subid",r.dataset.subid),i("GetSubHistory",e);break;case"depot":e.append("depotid",r.dataset.depotid),i("GetDepotHistory",e);break;case"bundle":e.append("bundleid",r.dataset.bundleid),i("GetBundleHistory",e);break;case"appsub":{e.append("appid",r.dataset.appid),i("GetAppHistory",e),e.delete("appid"),e.append("subid",r.dataset.subid),i("GetSubHistory",e);return}default:throw new Error("Unknown history scope")}}if(window.IntersectionObserver&&r&&!k){let e=0;const t=new window.IntersectionObserver(i=>{i.forEach(n=>{n.isIntersecting&&(e++>2&&t.unobserve(r),!r.hidden&&!r.disabled&&p())})},{root:null});t.observe(r)}})();
